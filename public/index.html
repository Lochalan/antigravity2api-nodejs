<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Token Manager</title>
    <!-- Prevent page flicker: set initial display based on login and tab state before rendering -->
    <script>
        (function() {
            var isLoggedIn = localStorage.getItem('authToken');
            var currentTab = localStorage.getItem('currentTab') || 'tokens';
            var classes = ['auth-ready'];
            if (isLoggedIn) classes.push('logged-in');
            if (currentTab === 'settings') classes.push('tab-settings');
            document.documentElement.className = classes.join(' ');
            // Detect font loading
            if ('fonts' in document) {
                document.fonts.ready.then(function() {
                    document.documentElement.classList.add('fonts-loaded');
                });
            } else {
                // Fallback: delayed addition
                setTimeout(function() {
                    document.documentElement.classList.add('fonts-loaded');
                }, 1000);
            }
        })();
    </script>
    <style>
/* Critical anti-flicker styles - from binary-build */
html:not(.auth-ready) #loginForm,
html:not(.auth-ready) #mainContent { visibility: hidden; }
/* Login state display control - merged from both branches */
.logged-in #loginForm { display: none !important; }
.logged-in #mainContent { display: flex !important; }
html:not(.logged-in) #mainContent { display: none !important; }
/* Tab state management - from binary-build */
html.tab-settings #tokensPage { display: none !important; }
html.tab-settings #settingsPage { display: block !important; }
html.tab-settings .tab[data-tab="tokens"] { 
    background: transparent !important;
    color: var(--text-light, #888) !important; 
}
html.tab-settings .tab[data-tab="settings"] { 
    background: var(--primary, #4f46e5) !important; 
    color: white !important; 
}
    </style>
    <!-- Main stylesheet - priority load -->
    <link rel="stylesheet" href="style.css">
    <!-- Preconnect to font servers -->
    <link rel="preconnect" href="https://font.sec.miui.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Async font loading - non-blocking -->
    <link rel="stylesheet" href="https://font.sec.miui.com/font/css?family=MiSans:400,500,600,700:Chinese_Simplify,Latin&display=swap" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:wght@400;700&display=swap" media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="https://font.sec.miui.com/font/css?family=MiSans:400,500,600,700:Chinese_Simplify,Latin&display=swap">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:wght@400;700&display=swap">
    </noscript>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginForm" class="login-form">
            <h2>Token Manager</h2>
            <form id="login">
                <div class="form-group">
                    <label>üë§ Username</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>üîë Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit">Login</button>
            </form>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="main-content hidden">
            <div class="header">
            <div class="tabs">
                <button class="tab active" data-tab="tokens" onclick="switchTab('tokens')">üéØ Token</button>
                <button class="tab" data-tab="settings" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            </div>
                <div class="header-right">
                    <button onclick="logout()">üö™ Logout</button>
                </div>
            </div>
            <div class="content">
                <!-- Token Management Page -->
                <div id="tokensPage">
                    <!-- Stats Cards + Action Buttons -->
                    <div class="top-bar">
                        <div class="stats-inline">
                            <div class="stat-item clickable active" onclick="filterTokens('all')">
                                <span class="stat-num" id="totalTokens">0</span>
                                <span class="stat-text">Total</span>
                            </div>
                            <div class="stat-item success clickable" onclick="filterTokens('enabled')">
                                <span class="stat-num" id="enabledTokens">0</span>
                                <span class="stat-text">Enabled</span>
                            </div>
                            <div class="stat-item danger clickable" onclick="filterTokens('disabled')">
                                <span class="stat-num" id="disabledTokens">0</span>
                                <span class="stat-text">Disabled</span>
                            </div>
                        </div>
                        <div class="action-btns">
                            <button type="button" onclick="showOAuthModal()" class="btn btn-success btn-sm">üîê OAuth</button>
                            <button type="button" onclick="showManualModal()" class="btn btn-secondary btn-sm">‚úèÔ∏è Manual</button>
                            <button type="button" onclick="loadTokens()" class="btn btn-warning btn-sm">üîÑ Refresh</button>
                            <button type="button" onclick="toggleSensitiveInfo()" class="btn btn-sm" id="toggleSensitiveBtn" title="Hide/Show sensitive info">üëÅÔ∏è Show</button>
                        </div>
                    </div>

                    <!-- Token Grid -->
                    <div id="tokenList" class="token-grid">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <div class="empty-state-text">No Tokens</div>
                            <div class="empty-state-hint">Click OAuth button above to add tokens</div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settingsPage" class="hidden">
                    <form id="configForm" class="config-form">
                        <div class="config-grid">
                            <!-- Server Configuration -->
                            <div class="config-section">
                                <h4>üñ•Ô∏è Server</h4>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Port</label>
                                        <input type="number" name="PORT" placeholder="8045">
                                    </div>
                                    <div class="form-group compact">
                                        <label>Listen Address</label>
                                        <input type="text" name="HOST" placeholder="0.0.0.0">
                                    </div>
                                </div>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Max Request Size</label>
                                        <input type="text" name="MAX_REQUEST_SIZE" placeholder="500mb">
                                    </div>
                                    <div class="form-group compact">
                                        <label>API Key</label>
                                        <input type="password" name="API_KEY" placeholder="Leave empty to skip validation">
                                    </div>
                                </div>
                                <div class="form-row-inline switch-row">
                                    <div class="form-group compact switch-group">
                                        <label>Skip Validation <span class="help-tip" data-tooltip="Skip ProjectId fetch, generate random ID (Pro accounts only)">?</span></label>
                                        <label class="switch">
                                            <input type="checkbox" name="SKIP_PROJECT_ID_FETCH">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="form-group compact switch-group">
                                        <label>Native Axios <span class="help-tip" data-tooltip="Use native axios instead of TLS fingerprint requester">?</span></label>
                                        <label class="switch">
                                            <input type="checkbox" name="USE_NATIVE_AXIOS">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group compact">
                                    <label>Image Access URL</label>
                                    <input type="text" name="IMAGE_BASE_URL" placeholder="https://your-domain.zeabur.app">
                                </div>
                                <div class="form-group compact">
                                    <label>Proxy Address</label>
                                    <input type="text" name="PROXY" placeholder="http://127.0.0.1:7890">
                                </div>
                            </div>

                            <!-- Model Parameters -->
                            <div class="config-section">
                                <h4>üéõÔ∏è Model Parameters</h4>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Temperature</label>
                                        <input type="number" step="0.1" name="DEFAULT_TEMPERATURE" placeholder="1">
                                    </div>
                                    <div class="form-group compact">
                                        <label>Top P</label>
                                        <input type="number" step="0.01" name="DEFAULT_TOP_P" placeholder="1">
                                    </div>
                                </div>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Top K</label>
                                        <input type="number" name="DEFAULT_TOP_K" placeholder="50">
                                    </div>
                                    <div class="form-group compact">
                                        <label>Max Tokens</label>
                                        <input type="number" name="DEFAULT_MAX_TOKENS" placeholder="32000">
                                    </div>
                                </div>
                                <div class="form-group compact highlight">
                                    <label>Thinking Budget <span class="help-tip" data-tooltip="Token budget for thinking models, affects reasoning depth">?</span></label>
                                    <input type="number" name="DEFAULT_THINKING_BUDGET" placeholder="16000">
                                </div>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Effort Low <span class="help-tip" data-tooltip="Token budget when client sends reasoning_effort=low">?</span></label>
                                        <input type="number" name="REASONING_EFFORT_LOW" placeholder="1024">
                                    </div>
                                    <div class="form-group compact">
                                        <label>Effort Medium <span class="help-tip" data-tooltip="Token budget when client sends reasoning_effort=medium">?</span></label>
                                        <input type="number" name="REASONING_EFFORT_MEDIUM" placeholder="16000">
                                    </div>
                                    <div class="form-group compact">
                                        <label>Effort High <span class="help-tip" data-tooltip="Token budget when client sends reasoning_effort=high. Must be less than Max Tokens!">?</span></label>
                                        <input type="number" name="REASONING_EFFORT_HIGH" placeholder="24000">
                                    </div>
                                </div>
                                <div class="form-row-inline switch-row">
                                    <div class="form-group compact switch-group">
                                        <label>Context System <span class="help-tip" data-tooltip="Merge consecutive system messages at start into SystemInstruction">?</span></label>
                                        <label class="switch">
                                            <input type="checkbox" name="USE_CONTEXT_SYSTEM_PROMPT">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group compact">
                                    <label>System Prompt</label>
                                    <textarea name="SYSTEM_INSTRUCTION" rows="3" placeholder="Optional system prompt"></textarea>
                                </div>
                            </div>

                            <!-- Rotation Strategy & Performance -->
                            <div class="config-section">
                                <h4>üîÑ Rotation & Performance</h4>
                                <div class="form-row-inline switch-row">
                                    <div class="form-group compact switch-group">
                                        <label>Pass Signature <span class="help-tip" data-tooltip="Pass thoughtSignature from response to client">?</span></label>
                                        <label class="switch">
                                            <input type="checkbox" name="PASS_SIGNATURE_TO_CLIENT">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="form-group compact switch-group">
                                        <label>Disable Cache <span class="help-tip" data-tooltip="Disable server-side signature caching">?</span></label>
                                        <label class="switch">
                                            <input type="checkbox" name="DISABLE_SERVER_CACHE">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Strategy Mode <span class="help-tip" data-tooltip="Round Robin: Switch token each request&#10;Quota Exhausted: Switch when quota depleted&#10;Custom Count: Switch after specified requests">?</span></label>
                                        <select name="ROTATION_STRATEGY" id="rotationStrategy" onchange="toggleRequestCountInput()">
                                            <option value="round_robin">Round Robin</option>
                                            <option value="quota_exhausted">Quota Exhausted</option>
                                            <option value="request_count">Custom Count</option>
                                        </select>
                                    </div>
                                    <div class="form-group compact" id="requestCountGroup">
                                        <label>Requests per Token <span class="help-tip" data-tooltip="In custom count mode, number of requests before switching token">?</span></label>
                                        <input type="number" name="ROTATION_REQUEST_COUNT" min="1" placeholder="10">
                                    </div>
                                </div>
                                <div class="rotation-status" id="rotationStatus">
                                    <span class="rotation-label">Current Status:</span>
                                    <span id="currentRotationInfo">Loading...</span>
                                </div>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Timeout (ms)</label>
                                        <input type="number" name="TIMEOUT" placeholder="300000">
                                    </div>
                                    <div class="form-group compact">
                                        <label>429 Retry Count</label>
                                        <input type="number" name="RETRY_TIMES" placeholder="0">
                                    </div>
                                </div>

                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Heartbeat Interval (ms) <span class="help-tip" data-tooltip="SSE heartbeat interval to prevent CF timeout">?</span></label>
                                        <input type="number" name="HEARTBEAT_INTERVAL" placeholder="15000">
                                    </div>
                                    <div class="form-group compact">
                                        <label>Memory Threshold (MB) <span class="help-tip" data-tooltip="Trigger GC cleanup when exceeded">?</span></label>
                                        <input type="number" name="MEMORY_THRESHOLD" placeholder="100">
                                    </div>
                                </div>
                                <div class="form-group compact">
                                    <label>üî§ UI Font Size (px)</label>
                                    <div class="font-size-control">
                                        <input type="range" id="fontSizeRange" min="10" max="24" value="18" oninput="changeFontSize(this.value)">
                                        <input type="number" id="fontSizeInput" min="10" max="24" value="18" onchange="changeFontSize(this.value)" style="width: 60px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="config-actions">
                            <button type="submit" class="btn btn-success">üíæ Save Config</button>
                            <button type="button" onclick="loadConfig()" class="btn btn-secondary">üîÑ Reload</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Load modules in dependency order -->
    <script src="js/utils.js" defer></script>
    <script src="js/ui.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/quota.js" defer></script>
    <script src="js/tokens.js" defer></script>
    <script src="js/config.js" defer></script>
    <script src="js/main.js" defer></script>
</body>
</html>
